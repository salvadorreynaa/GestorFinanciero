{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/facturas.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="facturacion-container">
    <div class="alert alert-success" id="successAlert" style="display: none;">
        Factura generada correctamente
    </div>
    
    <div class="factura-form">
        <h2><i class="fas fa-file-invoice"></i> Emitir Nueva Factura</h2>
        
        <form id="facturaForm" onsubmit="return handleSubmit(event)">
            <div class="form-group">
                <label class="form-label" for="cliente">Cliente</label>
                <input type="text" id="cliente" name="cliente" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="documento">RUC o DNI</label>
                <input type="text" id="documento" name="documento" class="form-control" required
                       pattern="\d{8}|\d{11}" title="Ingrese 8 dígitos para DNI o 11 para RUC">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="descripcion">Descripción del servicio o producto</label>
                <textarea id="descripcion" name="descripcion" class="form-control" rows="3" required></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="cantidad">Cantidad</label>
                <input type="number" id="cantidad" name="cantidad" class="form-control" min="1" required
                       oninput="calcularTotal()">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="precio_unitario">Precio Unitario (S/)</label>
                <input type="number" id="precio_unitario" name="precio_unitario" class="form-control" 
                       min="0.01" step="0.01" required oninput="calcularTotal()">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="total">Total (S/)</label>
                <input type="text" id="total" class="form-control" readonly>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Generar Factura
                </button>
                <a href="{{ url_for('facturacion.index') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

{% block scripts %}
<script>
function calcularTotal() {
    const cantidad = document.getElementById('cantidad').value || 0;
    const precioUnitario = document.getElementById('precio_unitario').value || 0;
    const total = (parseFloat(cantidad) * parseFloat(precioUnitario)).toFixed(2);
    document.getElementById('total').value = `S/ ${total}`;
}

async function handleSubmit(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    try {
        const response = await fetch('{{ url_for("facturacion.emitir_factura") }}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            const alert = document.getElementById('successAlert');
            alert.style.display = 'block';
            alert.textContent = data.message;
            
            // Limpiar formulario
            form.reset();
            document.getElementById('total').value = '';
            
            // Redirigir después de 2 segundos
            setTimeout(() => {
                window.location.href = '{{ url_for("facturacion.index") }}';
            }, 2000);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al generar la factura. Por favor, intente nuevamente.');
    }
    
    return false;
}

// Inicializar cálculo del total
document.addEventListener('DOMContentLoaded', calcularTotal);
</script>
{% endblock %}

{% endblock %}
